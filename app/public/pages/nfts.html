<div>
  <div class="hidden">
    <label for="nftAuctionContractAddress">NFT Auction Contract Addy:</label>
    <input id="nft_auction_contract" name="nftAuctionContractAddress" type="text"></input><br />
    <button id="nft_contract_check_approval">Check Approval</button>
  </div>

  <div id="ntf_auction_set_approval_container" class="approve-wolvercoin-container">
    <button id="nft_auction_set_approval_button" class="approve-wolvercoin-button hidden">Approve Wolvercoin</button>
  </div>

  <div class="auction-grid" id="auction-grid">
  <div class="auction-item-container">
    <div class="auction-item-image">
    </div>
    <div class="auction-item-details">
      <div class="auction-item-row auction-item title">
        <div class="auction-item-price-title" id="auction-item-nft-name">Not-So-Fungible-Wolvies</div>
      </div>
      <div class="auction-item-row">
        <span class="auction-item-nft-name">NSFW #<span class="auction-item-nft-id"></span></span>
        <span class="auction-item-price-label">
          <span class="auction-item-price-title-fl">Price</span>
          <span class="crypto-icon">
            <span id="crypto_currency_price" class="crypto-currency">0.1</span>
          </span>
      </div>
      <div class="auction-item-row">
        <div class="auction-item-auction-time">
          <span id="auction-start-finish-text" class="auction-start-finish-text">begins</span>
          <span id="auction-start-finish-time" class="auction-start-finish-time">Nov 15th 13:35 pm PST</span>
        </div>
      </div>
      <div class="auction-item-auction-container hidden auction-item-row">
        <span><input id="auction-item-place-bid-input" class="auction-item-place-bid-input"></input>
        <button id="auction-item-place-bid">Place Bid</button>
        </span>
      </div>
      <div class="auction-item-auction-buy-now hidden"></div>
    </div>
  </div>

  </div>

  <!-- Begin template for auction item -->
</div>

<script>
  function auctionInteraction(event) {
    console.log('you interacted with auction id:' + event.data);
  }


  // This grabs the inner html which is just the auction container
  var auctionGrid = $('#auction-grid');
  var baseAuctionHTML = $("#auction-grid").html();
  $("#auction-grid").html('');

  // Create test html for single item
  let auctionDetails = {
    id : 5,
    imgUrl : 'https://lh3.googleusercontent.com/8tnMvh2mkQCrWp9tx6aKXcJNdI3dpqUyChFvY2B2EuLheJ-k55Lob-9zB2PgVcFpOFpw2IW_NA9zta-p07sizI1s-zy_9ZePdu1miQ=s0',
    latestBid : 3.2,
    startTimestamp : new Date().getTime() + 50000,
    endTimestamp : new Date().getTime() + 50000,
    highestBidder : null,
    auctionClaimed : false
  };
  function msToTime(ms) {
    let seconds = (ms / 1000).toFixed(1);
    let minutes = (ms / (1000 * 60)).toFixed(1);
    let hours = (ms / (1000 * 60 * 60)).toFixed(1);
    let days = (ms / (1000 * 60 * 60 * 24)).toFixed(1);
    if (seconds < 60) return Math.round(seconds) + " Sec";
    else if (minutes < 60) return minutes + " Min";
    else if (hours < 24) return hours + " Hrs";
    else return days + " Days"
  }

  console.log()

  // Takes auction item details, grabs details, appends to grid, binds interactions
  function generateAndAddAuction(_auctionDetails, baseHtml, auctionGrid) {
    var nextAuction = $(baseHtml).clone();
    nextAuction.find(".auction-item-nft-id").html(_auctionDetails.id);
    nextAuction.attr('name',_auctionDetails.id);

    // Handle timing for auction
    // Check for current, ended, or ending auction
    let timestampNow = new Date().getTime();
    if (_auctionDetails.startTimestamp > timestampNow) {
      console.log('auction hasnt started yet');// The auction hasn't started yet
      nextAuction.find(".auction-start-finish-text").html("Auction starts in:");
      var auctionBeginDifference = msToTime(_auctionDetails.startTimestamp - timestampNow);
      nextAuction.find(".auction-start-finish-time").html(auctionBeginDifference);


    } else if (_auctionDetails.endTimestamp > timestampNow) {
      console.log('auction finished');  // Auction finished
      nextAuction.find(".auction-start-finish-text").html("Auction starts on:");
      var auctionBeginDifference = _auctionDetails.startTimestamp - timestampNow;
      nextAuction.find(".auction-start-finish-time").html("Auction starts on:");


    } else if (_auctionDetails.startTimestamp < timestampNow || _auctionDetails.endTimestamp > timestampNow) {
        console.log('auction running');// Auction has started

    } else {
      // Auction is not up for auction
      console.log('clear out details of auction');

    }

    // Append to the auction grid
    auctionGrid.append(nextAuction);

    // Bind items
    var auctionToAdd = auctionGrid.find("[name='" + _auctionDetails.id + "']");
    auctionToAdd.on('click', _auctionDetails.id, auctionInteraction);
    return nextAuction;
  }

  // Generate auction
  generateAndAddAuction(auctionDetails, baseAuctionHTML, auctionGrid);


  console.log('create auction items');
</script>

<script>
  let hasApprovalForHWToken = false;
  let renderBidInterface = false;

  // Get the nft auction contract address
  let auctionContractAddress = "0x13066EE900a8C4e2C9cD7cE0096ADF9B907D0CfF";
  let inputAddress = $("#nft_auction_contract").val();
  if (inputAddress.length == auctionContractAddress.length) {
    auctionContractAddress = inputAddress;
  }

  function updateBalance() {

  }

  // Go through all available bid items and show the bid interface
  function showBidUI() {
    renderBidInterface = true;
    console.log('approved, show UI');
  }

  function showApproval() {
    $('#nft_auction_set_approval_button').show();
  }

  /*
   *  Checks to see if the auction contract is allowed to spend Wolvercoin
   *    - If yes, updates UI to allow bidding
   *    - If no, shows 'approve spend of wolvercoin'
   */
  async function checkAllowance() {
    console.log('checking allowance');

    // Check for approval, if so, show a different UI
    var web3 = new Web3(Web3.givenProvider || 'ws://some.local-or-remote.node:8546');
    const WolvercoinContract = new web3.eth.Contract(ECR20_WVCABI, WVC_ADDRESS.goerli);

    let allowance = null;
    // allowance takes (owner, spender) so (msg.sender, contractToSpend)
    await WolvercoinContract.methods.allowance(ethereum.selectedAddress, auctionContractAddress).call(async function(err, res) {
      console.log(err, res);

      // Call method to handle approved items or not
      if (res == '115792089237316195423570985008687907853269984665640564039457584007913129639935') { // show bidding options
        console.log('approval granted');
        showBidUI();
      } else { // show 'approve hw coin'
        await WolvercoinContract.methods.balanceOf(ethereum.selectedAddress).call(function(err, res) {
          // If they don't have wolvercoin, no need to approve
          if (res != "0") {
            showApproval();
          }
        });

      }
    });
  }
  checkAllowance();

  async function approveWolvercoin() {
    // Check for approval, if so, show a different UI
    var web3 = new Web3(Web3.givenProvider || 'ws://some.local-or-remote.node:8546');
    const WolvercoinContract = new web3.eth.Contract(ECR20_WVCABI, WVC_ADDRESS.goerli);
    let approve_amount = '115792089237316195423570985008687907853269984665640564039457584007913129639935'; //(2^256 - 1 )
    await WolvercoinContract.methods.approve(auctionContractAddress, approve_amount).send({
      from: ethereum.selectedAddress
    });

    checkAllowance();
  }
  $('#nft_auction_set_approval_button').click(function() {
    approveWolvercoin();
  });
</script>

<script>
  // Get auctions
  // Get all auction ID's
  // Go through auctions and grab each data
</script>
